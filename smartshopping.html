<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFC Cart Ordering System</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    h1, h2 { text-align: center; }
    #cartTable, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; }
    #cartTable { width: 100%; margin-top: 20px; }
    button { margin: 10px 0; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    #message { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>

<h1>NFC Cart Ordering</h1>

<button id="scanBtn">Scan NFC Tag</button>
<div id="message"></div>

<table id="cartTable" style="display:none;">
  <thead>
    <tr>
      <th>Item</th>
      <th>Qty</th>
      <th>Price</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody id="cartBody"></tbody>
</table>

<h3 id="cartSummary" style="display:none;">Total: ฿<span id="totalPrice">0</span> (<span id="totalQty">0</span> items)</h3>

<button id="submitBtn" style="display:none;">Place Order</button>

<!-- Optional manual input for testing -->
<div style="margin-top: 30px;">
  <h3>Manual NFC ID Input (for testing)</h3>
  <input type="text" id="manualInput" placeholder="Enter NFC ID" />
  <button onclick="onManualInput()">Simulate Scan</button>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbx0hoS5d-_j1K9NZCNRfHfcPQmx9xL_ylD0UPLGYwHiT4AcIAgf7nPJcuTdMUHB8-RZxQ/exec';

let inventory = [];
let cart = {};

async function fetchInventory() {
  try {
    const res = await fetch(API_URL);
    inventory = await res.json();
    console.log("Inventory loaded:", inventory);
  } catch (err) {
    alert("Failed to load inventory.");
  }
}

function updateCartDisplay() {
  const cartTable = document.getElementById('cartTable');
  const cartBody = document.getElementById('cartBody');
  const summary = document.getElementById('cartSummary');
  const totalQtyEl = document.getElementById('totalQty');
  const totalPriceEl = document.getElementById('totalPrice');
  const submitBtn = document.getElementById('submitBtn');

  cartBody.innerHTML = '';
  let totalQty = 0;
  let totalPrice = 0;

  for (const [itemName, item] of Object.entries(cart)) {
    const row = document.createElement('tr');
    const total = item.quantity * item.price;
    row.innerHTML = `
      <td>${itemName}</td>
      <td>${item.quantity}</td>
      <td>฿${item.price}</td>
      <td>฿${total}</td>
    `;
    cartBody.appendChild(row);
    totalQty += item.quantity;
    totalPrice += total;
  }

  if (totalQty > 0) {
    cartTable.style.display = '';
    summary.style.display = '';
    submitBtn.style.display = '';
    totalQtyEl.textContent = totalQty;
    totalPriceEl.textContent = totalPrice.toFixed(2);
  } else {
    cartTable.style.display = 'none';
    summary.style.display = 'none';
    submitBtn.style.display = 'none';
  }
}

function onNfcTagRead(serial) {
  const id = serial.replace(/:/g, '').toUpperCase();
  const product = inventory.find(item => item.NFC_ID.replace(/:/g, '').toUpperCase() === id);

  if (!product) {
    document.getElementById('message').textContent = 'Product not found for tag: ' + serial;
    return;
  }

  const name = product.ItemName;
  const stock = parseInt(product.Stock);
  const price = parseFloat(product.Price);

  if (!cart[name]) {
    cart[name] = { quantity: 1, price };
  } else {
    if (cart[name].quantity < stock) {
      cart[name].quantity += 1;
    } else {
      alert(`Not enough stock for ${name}`);
    }
  }

  document.getElementById('message').textContent = `${name} added to cart`;
  updateCartDisplay();
}

function onManualInput() {
  const input = document.getElementById('manualInput').value.trim();
  if (input) {
    onNfcTagRead(input);
  }
}

async function scanNfcTag() {
  if ('NDEFReader' in window) {
    try {
      const ndef = new NDEFReader();
      await ndef.scan();
      document.getElementById('message').textContent = 'Scanning NFC tag...';
      ndef.onreading = event => {
        const serial = event.serialNumber;
        onNfcTagRead(serial);
      };
    } catch (error) {
      alert('NFC scan failed: ' + error);
    }
  } else {
    alert('Web NFC not supported in this browser/device.');
  }
}

async function submitCart() {
  const cartArray = Object.entries(cart).map(([itemName, item]) => ({
    itemName,
    quantity: item.quantity
  }));

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cart: cartArray })
    });

    const text = await res.text();
    if (text.includes('Order successful')) {
      alert("✅ Order placed!");
      cart = {};
      updateCartDisplay();
    } else {
      alert("❌ Order failed: " + text);
    }
  } catch (err) {
    alert("❌ Error sending order: " + err.message);
  }
}

document.getElementById('scanBtn').addEventListener('click', scanNfcTag);
document.getElementById('submitBtn').addEventListener('click', submitCart);

fetchInventory();
</script>

</body>
</html>
