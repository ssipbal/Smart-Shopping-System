<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFC Inventory & Order System</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
  .hidden { display: none; }
  #orderSummaryTable, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; width: 100%; }
  #orderSummaryTable { margin-top: 20px; }
  button { padding: 10px 20px; margin: 5px; cursor: pointer; }
  #adminStockTable, th, td { border: 1px solid #aaa; border-collapse: collapse; padding: 8px; width: 100%; }
  #adminStockTable { margin-top: 20px; }
</style>
</head>
<body>

<div id="landingPage">
  <h2>Select Role</h2>
  <button id="customerBtn">Customer</button>
  <button id="adminBtn">Admin</button>
</div>

<!-- Admin Login -->
<div id="adminLogin" class="hidden">
  <h2>Admin Login</h2>
  <input type="password" id="adminCodeInput" placeholder="Enter Admin Code" />
  <button id="adminLoginBtn">Login</button>
  <button id="adminBackBtn">Back</button>
  <div id="adminLoginMsg" style="color:red; margin-top:10px;"></div>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden">
  <h2>Admin Panel - Stock Management</h2>
  <table id="adminStockTable">
    <thead>
      <tr><th>Item</th><th>Stock</th><th>Price</th><th>Add Stock</th><th>Remove Stock</th><th>Delete Item</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>Add New Item</h3>
  <input type="text" id="newNfcId" placeholder="NFC ID (no colons)" />
  <input type="text" id="newItemName" placeholder="Item Name" />
  <input type="number" id="newStock" placeholder="Stock" min="0" />
  <input type="number" id="newPrice" placeholder="Price" min="0" step="0.01" />
  <button id="addNewItemBtn">Add Item</button>
  <button id="adminLogoutBtn" style="margin-top: 20px;">Logout</button>
  <div id="adminMsg" style="color:green; margin-top:10px;"></div>
</div>

<!-- Customer Panel -->
<div id="customerPanel" class="hidden">
  <h2>Customer - Order Summary</h2>

  <label>Scan Product (Enter NFC ID):</label><br />
  <input type="text" id="nfcInput" placeholder="Enter NFC ID, e.g. 04F1458B320289" />
  <button id="scanBtn">Scan</button>

  <div id="popup" class="hidden" style="border:1px solid #000; padding: 15px; margin-top: 15px; background:#eee;">
    <h3 id="popupProductName"></h3>
    <p>Price: ฿<span id="popupPrice"></span></p>
    <label>Quantity:</label>
    <input type="number" id="popupQuantity" min="1" value="1" />
    <br /><br />
    <button id="popupSubmitBtn">Add to Order</button>
    <button id="popupCancelBtn">Cancel</button>
  </div>

  <table id="orderSummaryTable" class="hidden">
    <thead>
      <tr><th>Item</th><th>Quantity</th><th>Price</th><th>Total</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3 id="orderTotal" class="hidden">Total: ฿0.00</h3>
  <button id="submitOrderBtn" class="hidden">Submit Order</button>
  <button id="customerLogoutBtn" style="margin-top:20px;">Back to Role Selection</button>
  <div id="customerMsg" style="color:green; margin-top:10px;"></div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwoQm8BKVh2xoyrjxDJ-PEuyvq7NeHwNtS0mqSjUp_E3_DTN8pM3tl0aMnG2W3e-zD-5A/exec'; // << REPLACE with your Apps Script URL

// Pages
const landingPage = document.getElementById('landingPage');
const adminLogin = document.getElementById('adminLogin');
const adminPanel = document.getElementById('adminPanel');
const customerPanel = document.getElementById('customerPanel');

// Landing buttons
document.getElementById('customerBtn').onclick = () => {
  landingPage.classList.add('hidden');
  customerPanel.classList.remove('hidden');
  loadInventory();
};

document.getElementById('adminBtn').onclick = () => {
  landingPage.classList.add('hidden');
  adminLogin.classList.remove('hidden');
  document.getElementById('adminCodeInput').value = '';
  document.getElementById('adminLoginMsg').textContent = '';
};

// Admin login
document.getElementById('adminLoginBtn').onclick = () => {
  const code = document.getElementById('adminCodeInput').value;
  if (code === '12345') {
    adminLogin.classList.add('hidden');
    adminPanel.classList.remove('hidden');
    loadInventoryAdmin();
  } else {
    document.getElementById('adminLoginMsg').textContent = 'Incorrect code';
  }
};

document.getElementById('adminBackBtn').onclick = () => {
  adminLogin.classList.add('hidden');
  landingPage.classList.remove('hidden');
};

// Customer logout
document.getElementById('customerLogoutBtn').onclick = () => {
  customerPanel.classList.add('hidden');
  landingPage.classList.remove('hidden');
  clearOrder();
};

// Admin logout
document.getElementById('adminLogoutBtn').onclick = () => {
  adminPanel.classList.add('hidden');
  landingPage.classList.remove('hidden');
  document.getElementById('adminMsg').textContent = '';
};

// Global inventory array for customer and admin
let inventory = [];
// Customer cart object { nfcId: {ItemName, Price, Quantity} }
let cart = {};

// Fetch inventory from backend
async function loadInventory() {
  try {
    const res = await fetch(API_URL);
    inventory = await res.json();
  } catch (e) {
    alert('Failed to load inventory.');
  }
}

// For Admin view — load inventory and display stock table
async function loadInventoryAdmin() {
  try {
    const res = await fetch(API_URL);
    inventory = await res.json();
    renderAdminTable();
  } catch (e) {
    alert('Failed to load inventory.');
  }
}

// Render Admin stock table
function renderAdminTable() {
  const tbody = document.querySelector('#adminStockTable tbody');
  tbody.innerHTML = '';
  inventory.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.ItemName}</td>
      <td>${item.Stock}</td>
      <td>฿${item.Price}</td>
      <td><button onclick="addStock('${item.NFC_ID}')">+ Add</button></td>
      <td><button onclick="removeStock('${item.NFC_ID}')">- Remove</button></td>
      <td><button onclick="deleteItem('${item.NFC_ID}')">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// Admin actions
async function addStock(nfcId) {
  const amount = prompt('Enter amount to add:', '1');
  const num = parseInt(amount);
  if (isNaN(num) || num <= 0) return alert('Invalid amount');
  await updateStock(nfcId, num);
}

async function removeStock(nfcId) {
  const amount = prompt('Enter amount to remove:', '1');
  const num = parseInt(amount);
  if (isNaN(num) || num <= 0) return alert('Invalid amount');
  await updateStock(nfcId, -num);
}

async function deleteItem(nfcId) {
  if (!confirm('Delete this item?')) return;
  try {
    // For simplicity, remove stock to 0 will effectively delete item for now
    await updateStock(nfcId, -999999);
    alert('Item deleted (stock set to 0)');
    loadInventoryAdmin();
  } catch {
    alert('Failed to delete item');
  }
}

// Update stock helper
async function updateStock(nfcId, amountChange) {
  // Fetch current item
  const item = inventory.find(i => i.NFC_ID === nfcId);
  if (!item) return alert('Item not found');

  let newStock = parseInt(item.Stock) + amountChange;
  if (newStock < 0) newStock = 0;

  try {
    // Google Apps Script POST update stock by resubmitting whole stock row
    // We'll send a cart-like array with 1 item quantity change (negative or positive)

    // Create "fake" cart with quantity = newStock
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        cart: [{ nfcId, quantity: newStock }]
      })
    });
    const text = await res.text();
    if (text.includes('Order successful')) {
      document.getElementById('adminMsg').textContent = `Stock updated for ${item.ItemName}`;
      loadInventoryAdmin();
    } else {
      alert('Failed to update stock: ' + text);
    }
  } catch (e) {
    alert('Failed to update stock');
  }
}

// CUSTOMER SIDE

// On Scan button clicked (simulate scan by NFC ID input)
document.getElementById('scanBtn').onclick = () => {
  const nfcInput = document.getElementById('nfcInput').value.trim();
  if (!nfcInput) return alert('Please enter NFC ID');
  simulateScan(nfcInput);
  document.getElementById('nfcInput').value = '';
};

// Simulate scan — lookup product by NFC ID and show popup
function simulateScan(nfcId) {
  const id = nfcId.toUpperCase().replace(/:/g, '');
  const product = inventory.find(p => p.NFC_ID.toUpperCase().replace(/:/g, '') === id);
  if (!product) {
    alert('Product not found for NFC ID: ' + nfcId);
    return;
  }
  showPopup(product);
}

// Show popup for quantity input
function showPopup(product) {
  document.getElementById('popupProductName').textContent = product.ItemName;
  document.getElementById('popupPrice').textContent = product.Price;
  document.getElementById('popupQuantity').value = 1;
  document.getElementById('popup').dataset.nfcId = product.NFC_ID;
  document.getElementById('popup').dataset.price = product.Price;
  document.getElementById('popup').dataset.itemName = product.ItemName;
  document.getElementById('popup').classList.remove('hidden');
}

// Popup buttons
document.getElementById('popupSubmitBtn').onclick = () => {
  const qty = parseInt(document.getElementById('popupQuantity').value);
  if (isNaN(qty) || qty <= 0) return alert('Invalid quantity');
  const nfcId = document.getElementById('popup').dataset.nfcId;
  const price = parseFloat(document.getElementById('popup').dataset.price);
  const itemName = document.getElementById('popup').dataset.itemName;

  // Check stock available
  const product = inventory.find(p => p.NFC_ID === nfcId);
  if (!product) return alert('Product not found');
  if (qty > product.Stock) return alert(`Only ${product.Stock} left in stock`);

  addToCart(nfcId, itemName, price, qty);
  document.getElementById('popup').classList.add('hidden');
  updateOrderSummary();
};

document.getElementById('popupCancelBtn').onclick = () => {
  document.getElementById('popup').classList.add('hidden');
};

// Add to cart
function addToCart(nfcId, itemName, price, quantity) {
  if (cart[nfcId]) {
    let newQty = cart[nfcId].quantity + quantity;
    const product = inventory.find(p => p.NFC_ID === nfcId);
    if (newQty > product.Stock) {
      alert(`Cannot add. Only ${product.Stock} in stock.`);
      return;
    }
    cart[nfcId].quantity = newQty;
  } else {
    cart[nfcId] = { itemName, price, quantity };
  }
}

// Update order summary table
function updateOrderSummary() {
  const tbody = document.querySelector('#orderSummaryTable tbody');
  const table = document.getElementById('orderSummaryTable');
  const totalEl = document.getElementById('orderTotal');
  const submitBtn = document.getElementById('submitOrderBtn');

  tbody.innerHTML = '';
  let total = 0;
  let hasItems = false;

  for (const nfcId in cart) {
    hasItems = true;
    const item = cart[nfcId];
    const rowTotal = item.price * item.quantity;
    total += rowTotal;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.itemName}</td>
      <td>
        <input type="number" min="1" max="${getStock(nfcId)}" value="${item.quantity}" data-nfcid="${nfcId}" class="qtyInput" />
      </td>
      <td>฿${item.price}</td>
      <td>฿${rowTotal.toFixed(2)}</td>
      <td><button data-nfcid="${nfcId}" class="deleteBtn">Delete</button></td>
    `;
    tbody.appendChild(tr);
  }

  if (hasItems) {
    table.classList.remove('hidden');
    totalEl.classList.remove('hidden');
    submitBtn.classList.remove('hidden');
    totalEl.textContent = `Total: ฿${total.toFixed(2)}`;
  } else {
    table.classList.add('hidden');
    totalEl.classList.add('hidden');
    submitBtn.classList.add('hidden');
  }

  // Add event listeners to qty inputs and delete buttons
  document.querySelectorAll('.qtyInput').forEach(input => {
    input.on
