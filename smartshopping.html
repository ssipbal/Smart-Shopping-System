<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NFC Inventory & Ordering System</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; }
  h1, h2 { text-align: center; }
  #productInfo { margin-top: 20px; padding: 15px; border: 1px solid #ddd; display: none; }
  label { display: block; margin-top: 10px; }
  input[type=number] { width: 80px; padding: 5px; }
  button { margin-top: 15px; padding: 8px 16px; font-size: 16px; cursor: pointer; }
  #message { margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>

<h1>NFC Inventory & Ordering System</h1>

<button id="scanBtn">Scan NFC Tag</button>

<div id="message"></div>

<div id="productInfo">
  <h2>Product Details</h2>
  <p><strong>Name:</strong> <span id="prodName"></span></p>
  <p><strong>Stock:</strong> <span id="prodStock"></span></p>
  <p><strong>Price:</strong> à¸¿<span id="prodPrice"></span></p>

  <label for="orderQty">Order Quantity:</label>
  <input type="number" id="orderQty" min="1" value="1" />

  <button id="orderBtn">Place Order</button>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbx3Fr8GIbYWjdwfH-TlLqLsAKLGxuUOeWIHiXNUod-j4LDPxrCElViBxyX7lrr1hfv8pQ/exec';

  let inventory = [];
  let currentProduct = null;

  async function fetchInventory() {
    try {
      const response = await fetch(`${API_URL}?action=getInventory`);
      inventory = await response.json();
      console.log("Inventory loaded:", inventory);
    } catch (err) {
      alert("Failed to load inventory: " + err.message);
    }
  }

  async function scanNfcTag() {
    if ('NDEFReader' in window) {
      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        document.getElementById('message').textContent = 'Scan NFC tag now...';

        ndef.onreading = event => {
          const serial = event.serialNumber.toUpperCase();
          document.getElementById('message').textContent = 'NFC Tag scanned: ' + serial;
          onNfcTagRead(serial);
        };
      } catch (error) {
        alert('NFC scan failed: ' + error);
      }
    } else {
      alert('Web NFC not supported on this browser.');
    }
  }

  function onNfcTagRead(serialNumber) {
    const cleanSerial = serialNumber.replace(/:/g, '').toUpperCase();

    currentProduct = inventory.find(item => {
      if (!item.NFC_ID) return false;
      let itemId = item.NFC_ID.replace(/:/g, '').toUpperCase();
      return itemId === cleanSerial;
    });

    if (currentProduct) {
      showProduct(currentProduct);
    } else {
      alert("Product not found for NFC tag: " + serialNumber);
      hideProduct();
    }
  }

  function showProduct(product) {
    document.getElementById('productInfo').style.display = 'block';
    document.getElementById('prodName').textContent = product.ItemName;
    document.getElementById('prodStock').textContent = product.Stock;
    document.getElementById('prodPrice').textContent = product.Price;
    document.getElementById('orderQty').max = product.Stock > 0 ? product.Stock : 1;
    document.getElementById('orderQty').value = 1;
    document.getElementById('message').textContent = '';
  }

  function hideProduct() {
    document.getElementById('productInfo').style.display = 'none';
  }

  async function placeOrder() {
    if (!currentProduct) {
      alert("No product selected.");
      return;
    }

    const qtyInput = document.getElementById('orderQty');
    const quantity = parseInt(qtyInput.value);

    if (quantity <= 0 || quantity > currentProduct.Stock) {
      alert("Invalid quantity.");
      return;
    }

    const orderData = {
      itemName: currentProduct.ItemName,
      quantity: quantity
    };

    try {
      const res = await fetch(`${API_URL}?action=submitOrder`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(orderData)
      });

      const text = await res.text();
      if (text === "Order successful") {
        alert(`Order placed for ${quantity} x ${currentProduct.ItemName}`);

        currentProduct.Stock -= quantity;
        document.getElementById('prodStock').textContent = currentProduct.Stock;
        qtyInput.max = currentProduct.Stock > 0 ? currentProduct.Stock : 1;
        if (currentProduct.Stock === 0) {
          alert("Product out of stock now.");
        }
      } else {
        alert("Order failed: " + text);
      }
    } catch (err) {
      alert("Order failed: " + err.message);
    }
  }

  document.getElementById('scanBtn').addEventListener('click', scanNfcTag);
  document.getElementById('orderBtn').addEventListener('click', placeOrder);

  fetchInventory();
</script>

</body>
</html>
